<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keep Fast</title>
    <link rel="icon" href="sticky-note.png" title="generator icons" type="image/png">
    <!-- Marked JavaScript library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-family: Consolas, Monaco, 'Courier New', Courier, monospace;
        }

        /* For light theme */
        body.bg-light .form-control::placeholder,
        body.bg-light .border::placeholder {
            color: #6c757d;
        }

        /* For dark theme */
        body.bg-dark .form-control::placeholder,
        body.bg-dark .border::placeholder {
            color: #adb5bd;
        }

        body.bg-light pre {
            color: #212529;
            border: 1px solid #ced4da;
        }

        body.bg-dark pre {
            background-color: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
        }

        /* For Mobile */
        @media (max-width: 576px) {
            * {
                font-size: 15px;
            }

            pre,
            span {
                font-size: 10px;
            }
        }
    </style>
</head>

<body class="container">
    <div id="searchApp" class="d-none mb-3">
        <div class="mt-3 input-group">
            <button id="configButton" class="border" title="Reset firebase configuration"
                onclick="setConfig()">üñ•Ô∏è</button>
            <button class="border" onclick="deleteData(document.getElementById('search').value);">‚ùå</button>
            <button class="border" onclick="
                originalVal = '';
                document.getElementById('result').innerHTML = '';
                document.getElementById('search').focus();">üóëÔ∏è</button>
            <input id="search" placeholder="Search" class="form-control">
            <button class="border" onclick="searchFun(document.getElementById('search').value)">üîç</button>
            <button class="border" onclick="
                const codeText = originalVal;
                navigator.clipboard.writeText(codeText)
                    .then(() => {
                        event.target.textContent = '‚úÖ'; 
                        setTimeout(() => {
                            event.target.textContent = 'üìã'; 
                        }, 2000); 
                    })
                    .catch((error) => {
                        console.error('Error copying text: ', error);
                    });
            ">üìã</button>
            <button class="border" onclick="
                    document.getElementById('titleInput').value = document.getElementById('search').value;
                    document.getElementById('description').value = originalVal
                    document.getElementById('storeDiv').classList.remove('d-none')
                    document.getElementById('titleInput').focus()">
                ‚úçÔ∏è</button>
            <button class="border" onclick="
                const searchTitles = document.getElementById('searchTitles');
                    if (this.textContent.trim() === '‚¨Ü') {
                        this.textContent = '‚¨á';
                        searchTitles.classList.add('d-none');
                    } else {
                        this.textContent = '‚¨Ü';
                        searchTitles.classList.remove('d-none');
                    }
                ">‚¨Ü</button>
            <button id="themeBtn" class="border" onclick="changeTheme()">‚¨§</button>
        </div>
        <div id="searchTitles" class="mt-3 d-flex flex-wrap"></div>
        <div id="storeDiv" class="d-none">
            <div class="mt-3 input-group">
                <button class="border" onclick="
                        // if (document.getElementById('titleInput').value == '' && document.getElementById('description').value == '') {
                            document.getElementById('search').focus();
                            document.getElementById('storeDiv').classList.add('d-none');
                        // }
                        // else {
                            // document.getElementById('titleInput').value = '';
                            // document.getElementById('description').value = '';
                            // document.getElementById('titleInput').focus();
                        // }
                        ">
                    üßπ
                </button>
                <input id="titleInput" placeholder="Title" class="form-control">
                <button id="saveBtn" class="border"
                    onclick="createData(document.getElementById('titleInput').value, document.getElementById('description').value)">üñ•Ô∏è</button>
            </div>
            <textarea id="description" placeholder="Write description in markdown syntax" class="mt-3 form-control"
                rows="20"></textarea>
        </div>

        <div id="result" class="mt-3"></div>
    </div>
    <div class="container mt-3">
        <div id="info2" class="card shadow p-4">
            <h2 class="card-title text-center mb-4">Welcome to the KeepFast</h2>
            <div class="card-body">
                <p class="mb-3">This is a simple note-taking application, similar to Google Keep.</p>
                <p class="mb-3">
                    Your notes will be stored in your Firebase database. To get started, go to
                    <a href="https://console.firebase.google.com/" target="_blank"
                        class="text-decoration-none text-primary">
                        Firebase Console
                    </a>, create a project, and select "web" to create an app.
                    Copy the given Firebase configuration and paste it here. Ensure each key is wrapped in double
                    quotes, like this:
                    <code>"apiKey"</code>.
                </p>
                <p class="mb-3">
                    Create a Realtime Database and set the rules as follows:
                <pre class="p-3 rounded"><code>{
    "rules": {
        ".read": true,
        ".write": true
    }
}</code></pre>
                </p>
                <p class="mb-3">
                    Your Firebase configuration will be stored in your browser's <code>localStorage</code>. No
                    irrelevant or excessive data will be stored in your database, and your data will not be stored
                    anywhere else.
                    The source code can be viewed in the browser's Inspect tab.
                </p>
                <p class="text-success text-center fw-bold">Happy Noting !!!</p>
            </div>
            <div id="info1">
                <div class="h6 mt-3">Firebase Configuration</div>
            </div>
            <div id="messageDiv"></div>
            <textarea id="firebaseConfigTextarea" class="mt-3 form-control" rows="10" placeholder='{
    "apiKey": "XYZ",
    "authDomain": "XYZ",
    "databaseURL": "XYZ",
    "projectId": "XYZ",
    "storageBucket": "XYZ",
    "messagingSenderId": "XYZ",
    "appId": "XYZ",
    "measurementId": "XYZ"
}'></textarea>
            <button id="setConfigBtn" class="border mt-3" title="Set firebase configuration"
                onclick="setConfig()">Connect</button>

        </div>
    </div>

    <div class="mb-3 text-center">Made with ‚ù§Ô∏è by <a href="https://github.com/deep-govindvira"
            class="link-primary">Deep Govindvira</a></div>
    <script>

        window.changeTheme = function () {
            var body = document.body;
            var formControls = document.querySelectorAll('.form-control, .border, .card');
            var preElements = document.querySelectorAll('pre');
            let currentTheme = localStorage.getItem('theme');

            if (currentTheme === 'dark') {
                localStorage.setItem('theme', 'light');
                body.classList.remove('bg-dark', 'text-light');
                body.classList.add('bg-light', 'text-dark');
                formControls.forEach(function (element) {
                    element.classList.remove('bg-dark', 'text-light');
                    element.classList.add('bg-light', 'text-dark');
                });

                preElements.forEach(function (element) {
                    element.classList.remove('bg-dark', 'text-light');
                    element.classList.add('bg-light', 'text-dark');
                });
            } else {
                localStorage.setItem('theme', 'dark');
                body.classList.remove('bg-light', 'text-dark');
                body.classList.add('bg-dark', 'text-light');

                formControls.forEach(function (element) {
                    element.classList.remove('bg-light', 'text-dark');
                    element.classList.add('bg-dark', 'text-light');
                });
                preElements.forEach(function (element) {
                    element.classList.remove('bg-light', 'text-dark');
                    element.classList.add('bg-dark', 'text-light');
                });
            }
        }

        window.onload = function () {
            var savedTheme = localStorage.getItem('theme');
            var body = document.body;
            var formControls = document.querySelectorAll('.form-control, .border, .card');
            var preElements = document.querySelectorAll('pre');

            if (savedTheme === 'dark') {
                body.classList.add('bg-dark', 'text-light');

                formControls.forEach(function (element) {
                    element.classList.add('bg-dark', 'text-light');
                });

                preElements.forEach(function (element) {
                    element.classList.add('bg-dark', 'text-light');
                });
            } else {
                body.classList.add('bg-light', 'text-dark');
                formControls.forEach(function (element) {
                    element.classList.add('bg-light', 'text-dark');
                });

                preElements.forEach(function (element) {
                    element.classList.add('bg-light', 'text-dark');
                });
            }
        };


        const markdownInput = document.getElementById('markdown-input');
        let originalVal = '';

        let messageDiv = document.getElementById('messageDiv')
        window.showMessage = function (message = 'Message', className = 'primary') {
            messageDiv.textContent = message
            messageDiv.role = 'alert'
            messageDiv.className = 'text-center mt-3 alert alert-' + className
            messageDiv.style.display = 'block'
            setTimeout(function () {
                messageDiv.className = ''
                messageDiv.textContent = ''
            }, 3000)
        }


    </script>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"
        import { getDatabase, ref, get, child, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js"

        let configButton = document.getElementById('configButton')
        let firebaseConfigTextarea = document.getElementById('firebaseConfigTextarea')
        let search = document.getElementById('search')
        let description = document.getElementById('description')

        window.setConfig = function () {
            if (configButton.textContent == 'üñ•Ô∏è') localStorage.setItem('firebaseConfig', document.getElementById('firebaseConfigTextarea').value)
            else {
                if (prompt("Want to reset firebase config, Enter 1 : ") != 1) {
                    // showMessage('Firebase configuration not reset', 'success')
                    return
                }
                localStorage.removeItem('firebaseConfig')
            }
            location.reload()
        }

        window.validateFirebaseId = function (id) {
            const encoder = new TextEncoder()
            if (encoder.encode(id).length > 1500) {
                return false
            }
            if (id.includes('/') || id.includes('.') || id.includes('#') || id.includes('$') || id.includes('[') || id.includes(']')) {
                return false
            }
            if (id === '.' || id === '..') {
                return false
            }
            if (/^__.*__$/.test(id)) {
                return false
            }
            return true
        }


        const firebaseConfig = localStorage.getItem('firebaseConfig')

        if (firebaseConfig) {
            try {
                const parsedConfig = JSON.parse(firebaseConfig)
                const app = initializeApp(parsedConfig)
                const db = getDatabase(app)
                firebaseConfigTextarea.className = 'd-none'
                searchApp.className = ''
                configButton.textContent = 'üî•'
                search.focus()
                // showMessage('Firebase connected successfully', 'success')

                window.createData = async function (key, data) {
                    try {
                        if (!validateFirebaseId(key)) {
                            // showMessage("Please change title", 'danger')
                            return
                        }
                        if (!data || data.trim() == '') {
                            // showMessage('Write Description', 'danger');
                            return
                        }
                        await set(ref(db, key), data)
                        // showMessage('Stored successfully', 'success')
                        description.focus()
                        document.getElementById('saveBtn').textContent = '‚úÖ';
                        setTimeout(() => {
                            document.getElementById('saveBtn').textContent = 'üñ•Ô∏è';
                        }, 2000);
                        displayAllTitles()
                        return true
                    } catch (error) {
                        // showMessage('Error string data', 'danger')
                    }
                }

                window.getData = async function (key) {
                    try {
                        if (!validateFirebaseId(key)) return null
                        const snapshot = await get(child(ref(db), key))
                        return snapshot.exists() ? snapshot.val() : null
                    } catch (error) {
                        return null
                    }
                }

                window.deleteData = async function (key) {
                    try {
                        if (!validateFirebaseId(key)) {
                            return;
                        }
                        if (prompt("Want to delete note ? Enter 1 : ") != 1) {
                            // showMessage('Isn\'t deleted', 'success');
                            return;
                        }
                        await remove(child(ref(db), key));
                        document.getElementById('search').value = ' '
                        displayAllTitles();
                        // showMessage('Deleted successfully', 'danger');
                        return true;
                    } catch (error) {
                        // showMessage('Not deleted', 'danger');
                        return false;
                    }
                }


                window.searchFun = async function (key) {
                    if (!key) {
                        // showMessage('Please write something to search', 'warning')
                        return
                    }
                    try {
                        const result = document.getElementById('result')
                        const cur = result.innerHTML;
                        result.innerHTML = "Searching ..." + cur
                        const response = await getData(key)
                        if (!response) {
                            result.innerHTML = cur
                            // showMessage('Not Found', 'warning')
                            return
                        }
                        originalVal = response + originalVal;
                        result.innerHTML = `<div class='card shadow p-4 mt-3 ${localStorage.getItem('theme') == 'dark' ? "bg-dark text-light border-secondary" : "border-secondary"}'>` + 
                            marked.parse(response) +
                            "</div>" + cur;

                    }
                    catch (e) {
                        // showMessage('Error in searching', 'danger')
                    }
                }

                window.displayAllTitles = async function () {
                    const titleRef = ref(db);
                    try {
                        const snapshot = await get(titleRef);
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            searchTitles.innerHTML = '';
                            for (const title in data) {
                                if (data.hasOwnProperty(title)) {
                                    const titleElement = document.createElement('div');
                                    titleElement.textContent = title;
                                    titleElement.classList.add('d-inline', 'p-2', 'm-1', 'border', 'rounded');
                                    titleElement.style.cursor = 'pointer'
                                    titleElement.onclick = function () {
                                        search.value = title;
                                        searchFun(title);
                                    };
                                    searchTitles.appendChild(titleElement);
                                }
                            }
                        } else {
                            // searchTitles.innerHTML = "No titles found!";
                        }
                    } catch (error) {
                        searchTitles.innerHTML = "Error fetching titles!";
                        // showMessage('Error fetching data', 'warning');
                    }
                }

                search.addEventListener("keydown", async function (event) {
                    if (event.key === "Enter") {
                        event.preventDefault(); // Prevents form submission if inside a form
                        searchFun(document.getElementById('search').value);
                    }
                });

                document.getElementById('titleInput').addEventListener("keydown", async function (event) {
                    if (event.key === "Enter" || event.key == "Tab") {
                        event.preventDefault();
                        document.getElementById('description').focus();
                    }
                });

                document.getElementById('description').addEventListener("keydown", async function (event) {
                    if (event.key === "Tab") {
                        event.preventDefault();
                        document.getElementById('saveBtn').focus();
                    }
                });

                document.getElementById('titleInput').addEventListener("keydown", function (event) {
                    if (event.ctrlKey && event.key === "s") {
                        event.preventDefault();
                        createData(document.getElementById('titleInput').value, document.getElementById('description').value)
                        displayAllTitles();

                    }
                });

                document.getElementById('description').addEventListener("keydown", function (event) {
                    if (event.ctrlKey && event.key === "s") {
                        event.preventDefault();
                        createData(document.getElementById('titleInput').value, document.getElementById('description').value)
                        displayAllTitles();
                    }
                });



                search.addEventListener("input", async function () {
                    const searchTerm = search.value.toLowerCase();
                    const titleRef = ref(db);
                    const searchTitles = document.getElementById('searchTitles')
                    try {
                        const snapshot = await get(titleRef);
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            searchTitles.innerHTML = '';
                            for (const title in data) {
                                if (data.hasOwnProperty(title) && title.toLowerCase().includes(searchTerm)) {
                                    const titleElement = document.createElement('div');
                                    titleElement.textContent = title;
                                    titleElement.classList.add('d-inline', 'p-2', 'm-1', 'border', 'rounded');
                                    titleElement.style.cursor = 'pointer'
                                    titleElement.onclick = function () {
                                        search.value = title;
                                        searchFun(title);
                                    };
                                    searchTitles.appendChild(titleElement);
                                }
                            }
                        } else {
                            searchTitles.innerHTML = "Please store some notes by clicking on pencil icon ‚úçÔ∏è .";
                        }
                    } catch (error) {
                        searchTitles.innerHTML = "Error fetching titles!";
                    }
                });

                displayAllTitles()

                document.getElementById('setConfigBtn').classList.add('d-none')
                document.getElementById('info1').classList.add('d-none');
                document.getElementById('info2').classList.add('d-none');


            } catch (e) {
                localStorage.removeItem('firebaseConfig')
                firebaseConfigTextarea.focus()
                showMessage('Invalid Firebase configuration', 'danger')
            }
        } else {
            firebaseConfigTextarea.focus()
            showMessage('Please enter Firebase configuration', 'warning')
        }
    </script>
</body>

</html>